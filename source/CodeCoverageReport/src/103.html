<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_103 = [
   [27,13,27,47,'dccv']
, [26,54,26,55,'dccv']
, [28,13,28,71,'dccv']
, [29,13,29,43,'dccv']
, [30,13,30,61,'dccv']
, [31,13,31,47,'dccv']
, [32,13,32,83,'dccv']
, [32,117,32,119,'dccv']
, [33,9,33,10,'dccv']
, [41,13,41,101,'dccv']
, [68,13,68,48,'dccv']
, [67,65,67,66,'dccv']
, [69,13,69,69,'dccv']
, [70,13,70,38,'dccv']
, [71,9,71,10,'dccv']
, [79,13,79,103,'dccv']
, [79,13,79,103,'dccv']
, [78,87,78,88,'dccv']
, [80,13,80,76,'dccv']
, [81,13,81,38,'dccv']
, [82,9,82,10,'dccv']
, [89,13,89,48,'dccv']
, [88,65,88,66,'dccv']
, [90,13,90,85,'dccv']
, [91,13,91,38,'dccv']
, [92,9,92,10,'dccv']
, [100,13,100,103,'dccv']
, [100,13,100,103,'dccv']
, [99,87,99,88,'dccv']
, [102,13,102,41,'dccv']
, [103,13,103,62,'dccv']
, [104,13,104,34,'dccv']
, [104,35,104,36,'dccv']
, [105,17,105,43,'dccv']
, [106,21,106,67,'dccv']
, [107,16,107,23,'dccv']
, [107,38,107,45,'dccv']
, [107,24,107,34,'dccv']
, [107,47,107,48,'dccv']
, [108,20,108,82,'dccv']
, [109,20,109,44,'dccv']
, [110,20,110,46,'dccv']
, [111,20,111,46,'dccv']
, [112,24,112,100,'dccv']
, [113,16,113,17,'dccv']
, [107,35,107,37,'dccv']
, [114,13,114,14,'dccv']
, [115,9,115,10,'dccv']
, [123,13,123,103,'dccv']
, [123,13,123,103,'dccv']
, [122,82,122,83,'dccv']
, [125,13,125,69,'dccv']
, [126,13,126,37,'dccv']
, [128,13,128,53,'dccv']
, [130,13,130,71,'dccv']
, [131,9,131,10,'dccv']
, [139,13,139,103,'dccv']
, [158,13,158,64,'dccv']
, [158,13,158,64,'dccv']
, [157,70,157,71,'dccv']
, [159,13,159,89,'dccv']
, [160,13,160,71,'dccv']
, [161,13,161,38,'dccv']
, [162,9,162,10,'dccv']
, [170,13,170,103,'dccv']
, [170,13,170,103,'dccv']
, [169,84,169,85,'dccv']
, [172,13,172,64,'dccv']
, [173,13,173,36,'dccv']
, [175,13,175,61,'dccv']
, [176,13,176,51,'dccv']
, [178,13,178,44,'dccv']
, [178,45,178,46,'dccv']
, [179,17,179,38,'dccv']
, [180,17,180,39,'dccv']
, [181,13,181,14,'dccv']
, [183,13,183,39,'dccv']
, [184,17,184,83,'dccv']
, [185,9,185,10,'dccv']
, [194,13,194,84,'dccv']
, [194,13,194,84,'dccv']
, [193,87,193,88,'dccv']
, [195,13,195,119,'dccv']
, [196,13,196,71,'dccv']
, [198,13,198,39,'dccv']
, [199,17,199,112,'dccv']
, [200,13,200,38,'dccv']
, [201,9,201,10,'dccv']
, [209,13,209,103,'dccv']
, [209,13,209,103,'dccv']
, [208,78,208,79,'dccv']
, [210,13,210,51,'dccv']
, [211,13,211,29,'dccv']
, [213,13,213,39,'dccv']
, [214,17,214,88,'dccv']
, [215,13,215,35,'dccv']
, [215,36,215,37,'dccv']
, [216,17,216,39,'dccv']
, [217,13,217,14,'dccv']
, [218,9,218,10,'dccv']
, [226,13,226,59,'dccv']
, [225,66,225,67,'dccv']
, [228,13,228,81,'dccv']
, [229,13,229,38,'dccv']
, [230,9,230,10,'dccv']
, [238,13,238,103,'dccv']
, [238,13,238,103,'dccv']
, [237,79,237,80,'dccv']
, [240,13,240,60,'dccv']
, [241,13,241,54,'dccv']
, [243,13,243,56,'dccv']
, [244,13,244,39,'dccv']
, [245,17,245,98,'dccv']
, [247,13,247,37,'dccv']
, [248,13,248,43,'dccv']
, [248,44,248,45,'dccv']
, [249,17,249,37,'dccv']
, [250,13,250,14,'dccv']
, [251,9,251,10,'dccv']
, [259,13,259,103,'dccv']
, [259,13,259,103,'dccv']
, [258,81,258,82,'dccv']
, [260,13,260,58,'dccv']
, [261,13,261,54,'dccv']
, [263,13,263,52,'dccv']
, [265,13,265,39,'dccv']
, [266,17,266,51,'dccv']
, [267,13,267,20,'dccv']
, [267,32,267,36,'dccv']
, [267,21,267,28,'dccv']
, [267,38,267,39,'dccv']
, [268,17,268,66,'dccv']
, [269,17,269,43,'dccv']
, [270,21,270,74,'dccv']
, [271,13,271,14,'dccv']
, [267,29,267,31,'dccv']
, [273,13,273,46,'dccv']
, [274,13,274,39,'dccv']
, [275,17,275,69,'dccv']
, [277,13,277,40,'dccv']
, [278,9,278,10,'dccv']
, [286,13,286,103,'dccv']
, [286,13,286,103,'dccv']
, [285,78,285,79,'dccv']
, [288,13,288,56,'dccv']
, [289,13,289,62,'dccv']
, [291,13,291,39,'dccv']
, [291,40,291,41,'dccv']
, [292,17,292,98,'dccv']
, [293,17,293,46,'dccv']
, [294,17,294,24,'dccv']
, [294,37,294,43,'dccv']
, [294,26,294,33,'dccv']
, [294,45,294,46,'dccv']
, [295,21,295,74,'dccv']
, [296,17,296,18,'dccv']
, [294,34,294,36,'dccv']
, [297,13,297,14,'dccv']
, [298,9,298,10,'dccv']
, [306,13,306,103,'dccv']
, [306,13,306,103,'dccv']
, [305,82,305,83,'dccv']
, [307,13,307,62,'dccv']
, [309,13,309,46,'dccv']
, [312,13,312,39,'dccv']
, [312,40,312,41,'dccv']
, [313,17,313,97,'dccv']
, [314,17,314,24,'dccv']
, [314,37,314,43,'dccv']
, [314,26,314,33,'dccv']
, [314,45,314,46,'dccv']
, [315,21,315,74,'dccv']
, [316,17,316,18,'dccv']
, [314,34,314,36,'dccv']
, [317,13,317,14,'dccv']
, [318,9,318,10,'dccv']
, [32,83,32,117,'dccv']
, [41,13,41,101,'dcuc']
, [40,82,40,83,'dcuc']
, [42,13,42,56,'dcuc']
, [43,13,43,24,'dcuc']
, [45,21,45,67,'dcuc']
, [46,21,46,27,'dcuc']
, [48,21,48,65,'dcuc']
, [49,21,49,27,'dcuc']
, [51,21,51,65,'dcuc']
, [52,21,52,48,'dcuc']
, [53,21,53,27,'dcuc']
, [55,21,55,71,'dcuc']
, [56,21,56,27,'dcuc']
, [58,21,58,66,'dcuc']
, [59,21,59,27,'dcuc']
, [61,9,61,10,'dcuc']
, [126,38,126,45,'dcuc']
, [128,54,128,61,'dcuc']
, [139,13,139,103,'dcuc']
, [138,83,138,84,'dcuc']
, [141,13,141,62,'dcuc']
, [142,13,142,56,'dcuc']
, [144,13,144,39,'dcuc']
, [144,40,144,41,'dcuc']
, [145,17,145,62,'dcuc']
, [146,17,146,24,'dcuc']
, [146,37,146,43,'dcuc']
, [146,26,146,33,'dcuc']
, [146,45,146,46,'dcuc']
, [147,21,147,118,'dcuc']
, [148,17,148,18,'dcuc']
, [146,34,146,36,'dcuc']
, [149,13,149,14,'dcuc']
, [150,9,150,10,'dcuc']
, [173,37,173,44,'dcuc']
, [211,30,211,37,'dcuc']
, [243,57,243,64,'dcuc']
, [263,53,263,60,'dcuc']
, [273,47,273,54,'dcuc']
, [309,47,309,48,'dcuc']
, [310,17,310,24,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src103" class="dotCoverSource"><pre>// &lt;copyright file=&quot;PirateClientCommands.cs&quot;&gt;
//      ahal@itu.dk
// &lt;/copyright&gt;
// &lt;summary&gt;
//      Various commands used by the PirateClientt to communicate with its host (PirateHost).
// &lt;/summary&gt;
// &lt;author&gt;Andreas Hallberg Kjeldsen (ahal@itu.dk)&lt;/author&gt;

namespace PirateSpades.Network {
    using System;
    using System.Linq;
    using System.Net.Sockets;
    using System.Diagnostics.Contracts;

    using PirateSpades.GameLogic;

    /// &lt;summary&gt;
    /// Various commands used by the PirateClientt to communicate with its host (PirateHost).
    /// &lt;/summary&gt;
    public class PirateClientCommands {
        /// &lt;summary&gt;
        /// Check if host is available.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;socket&quot;&gt;The socket to communicate through.&lt;/param&gt;
        /// &lt;returns&gt;True if host is available, false if not.&lt;/returns&gt;
        public static bool KnockKnock(Socket socket) {
            Contract.Requires(socket != null);
            var knock = new PirateMessage(PirateMessageHead.Knck, &quot;&quot;);
            socket.Send(knock.GetBytes());
            var buffer = new byte[PirateMessage.BufferSize];
            var read = socket.Receive(buffer);
            return read &gt; 4 &amp;&amp; PirateMessage.GetMessages(buffer, read).Any(msg =&gt; msg.Head == PirateMessageHead.Knck);
        }

        /// &lt;summary&gt;
        /// Receive an error message.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;msg&quot;&gt;Message to send.&lt;/param&gt;
        public static void ErrorMessage(PirateClient pclient, PirateMessage msg) {
            Contract.Requires(pclient != null &amp;&amp; msg != null &amp;&amp; msg.Head == PirateMessageHead.Erro);
            var err = PirateMessage.GetError(msg.Body);
            switch(err) {
                case PirateError.AlreadyConnected:
                    Console.WriteLine(&quot;You&#39;re already conncted!&quot;);
                    break;
                case PirateError.InvalidBet:
                    Console.WriteLine(&quot;Invalid bet specified!&quot;);
                    break;
                case PirateError.NameAlreadyTaken:
                    Console.WriteLine(&quot;Name is already taken!&quot;);
                    pclient.NameNotAvailable();
                    break;
                case PirateError.NoNewConnections:
                    Console.WriteLine(&quot;No more players can connect!&quot;);
                    break;
                case PirateError.Unknown:
                    Console.WriteLine(&quot;Unknown error happened!&quot;);
                    break;
            }
        }

        /// &lt;summary&gt;
        /// Initialize connection.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        public static void InitConnection(PirateClient pclient) {
            Contract.Requires(pclient != null);
            var msg = new PirateMessage(PirateMessageHead.Init, &quot;&quot;);
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// Verify connection with host.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void VerifyConnection(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Init);
            var msg = new PirateMessage(PirateMessageHead.Verf, data.Body);
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// Send player information.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        public static void SendPlayerInfo(PirateClient pclient) {
            Contract.Requires(pclient != null);
            var msg = new PirateMessage(PirateMessageHead.Pnfo, pclient.ToString());
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// Get players in game.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;Client receiving the data.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void GetPlayersInGame(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Pigm);

            pclient.Game.ClearPlayers();
            var players = PirateMessage.GetPlayerNames(data);
            if(players.Count &gt; 0) {
                if(!pclient.VirtualPlayer)
                    Console.WriteLine(&quot;Current players in game:&quot;);
               foreach(var player in players) {
                   var p = pclient.Name == player ? pclient : new Player(player);
                   p.SetGame(pclient.Game);
                   pclient.Game.AddPlayer(p);
                   if(!pclient.VirtualPlayer)
                       Console.WriteLine(&quot;\t&quot; + player + (pclient.Name == player ? &quot; (YOU)&quot; : &quot;&quot;));
               }
            }
        }

        /// &lt;summary&gt;
        /// Game has been started,
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void GameStarted(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Gstr);

            var startPlayer = PirateMessage.GetStartingPlayer(data);
            if (startPlayer == null) return;

            if (!pclient.Game.Contains(startPlayer)) return;

            pclient.Game.Start(pclient.Game.PlayerIndex(startPlayer));
        }

        /// &lt;summary&gt;
        /// Game has finished.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void GameFinished(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Gfin);

            var scores = PirateMessage.GetPlayerScores(data);
            var winner = PirateMessage.GetWinner(data);

            if(!pclient.VirtualPlayer) {
                Console.WriteLine(&quot;GAME FINISHED - Scores:&quot;);
                foreach (var kvp in scores) {
                    Console.WriteLine(&quot;\t&quot; + kvp.Key + &quot;: &quot; + kvp.Value + (kvp.Key == winner ? &quot; [WINNER!!!]&quot; : &quot;&quot;));
                }
            }
        }

        /// &lt;summary&gt;
        /// Play a card.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;card&quot;&gt;Card to be played.&lt;/param&gt;
        public static void PlayCard(PirateClient pclient, Card card) {
            Contract.Requires(pclient != null &amp;&amp; card != null);
            var body = PirateMessage.ConstructBody(pclient.ToString(), card.ToString());
            var msg = new PirateMessage(PirateMessageHead.Pcrd, body);
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// Receive a card played.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void GetPlayedCard(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Pcrd);

            var playerName = PirateMessage.GetPlayerName(data);
            if (playerName == null) return;

            var player = pclient.Game.GetPlayer(playerName);
            var card = Card.FromString(data.Body);
            
            if (pclient.Name != playerName) {
                player.GetCard(card);
                player.PlayCard(card);
            }

            if(!pclient.VirtualPlayer)
                Console.WriteLine(player.Name + &quot; plays &quot; + card.ToShortString());
        }

        /// &lt;summary&gt;
        /// Deal card to player.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;receiver&quot;&gt;Receiving player.&lt;/param&gt;
        /// &lt;param name=&quot;card&quot;&gt;Card dealt.&lt;/param&gt;
        public static void DealCard(PirateClient pclient, Player receiver, Card card) {
            Contract.Requires(pclient != null &amp;&amp; receiver != null &amp;&amp; card != null);
            var body = PirateMessage.ConstructBody(PirateMessage.ConstructPlayerName(receiver.Name), card.ToString());
            var msg = new PirateMessage(PirateMessageHead.Xcrd, body);

            if(!pclient.VirtualPlayer)
                Console.WriteLine(pclient.Name + &quot;: Dealing &quot; + card.ToShortString() + &quot; to &quot; + receiver.Name);
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// Get dealt card.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void GetCard(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Xcrd);
            var card = Card.FromString(data.Body);
            if(card == null) return;

            if(!pclient.VirtualPlayer)
                Console.WriteLine(pclient.Name + &quot;: Received &quot; + card.ToShortString());
            if (!pclient.IsDealer) {
                pclient.GetCard(card);
            }
        }

        /// &lt;summary&gt;
        /// Set the bet.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;bet&quot;&gt;Bet to use.&lt;/param&gt;
        public static void SetBet(PirateClient pclient, int bet) {
            Contract.Requires(pclient != null &amp; bet &gt;= 0);

            var msg = new PirateMessage(PirateMessageHead.Pbet, bet.ToString());
            pclient.SendMessage(msg);
        }

        /// &lt;summary&gt;
        /// A new round has been started.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void NewRound(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Nrnd);

            var dealerName = PirateMessage.GetDealer(data);
            var round = PirateMessage.GetRound(data);

            if (pclient.Game.CurrentRound + 1 != round) return;
            if(!pclient.VirtualPlayer)
                Console.WriteLine(&quot;Starting new round: &quot; + round + &quot; - Dealer is &quot; + dealerName);

            pclient.Game.NewRound();
            if(dealerName == pclient.Name) {
                pclient.DealCards();
            }
        }

        /// &lt;summary&gt;
        /// A round has begun.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void BeginRound(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Bgrn);
            var bets = PirateMessage.GetPlayerBets(data);
            var round = PirateMessage.GetRound(data);

            if (pclient.Game.CurrentRound != round) return;

            if(!pclient.VirtualPlayer)
                Console.WriteLine(&quot;Player bets:&quot;);
            foreach(var kvp in bets) {
                pclient.Game.Round.PlayerBet(kvp.Key, kvp.Value);
                if(!pclient.VirtualPlayer)
                    Console.WriteLine(&quot;\t&quot; + kvp.Key + &quot;: &quot; + kvp.Value);
            }

            if (!pclient.Game.Round.BetsDone) return;
            if(!pclient.VirtualPlayer)
                Console.WriteLine(&quot;Round &quot; + round + &quot; has begun.&quot;);

            pclient.Game.Round.Begin();
        }

        /// &lt;summary&gt;
        /// A new pile has been created.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void NewPile(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Trdn);

            var winner = PirateMessage.GetWinner(data);
            var tricks = PirateMessage.GetPlayerTricks(data);

            if(!pclient.VirtualPlayer) {
                Console.WriteLine((winner == pclient.Name ? &quot;You&quot; : winner) + &quot; won the trick!&quot;);
                Console.WriteLine(&quot;Tricks:&quot;);
                foreach (var kvp in tricks) {
                    Console.WriteLine(&quot;\t&quot; + kvp.Key + &quot;: &quot; + kvp.Value);
                }
            }
        }

        /// &lt;summary&gt;
        /// A round has finished.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;pclient&quot;&gt;The client.&lt;/param&gt;
        /// &lt;param name=&quot;data&quot;&gt;Data received from host.&lt;/param&gt;
        public static void FinishRound(PirateClient pclient, PirateMessage data) {
            Contract.Requires(pclient != null &amp;&amp; data != null &amp;&amp; data.Head == PirateMessageHead.Frnd);
            var scores = PirateMessage.GetPlayerScores(data);

            if (!pclient.Game.Round.Finished) {
                return;
            }
            if(!pclient.VirtualPlayer) {
                Console.WriteLine(&quot;Round &quot; + pclient.Game.CurrentRound + &quot; finished - Scores:&quot;);
                foreach (var kvp in scores) {
                    Console.WriteLine(&quot;\t&quot; + kvp.Key + &quot;: &quot; + kvp.Value);
                }
            }
        }
    }
}
</pre></code><script type="text/javascript">
			applyranges('src103', RANGES_103)
		</script>
	</body>
</html>