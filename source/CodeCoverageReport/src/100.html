<html>
	<head>
		<script type="text/javascript" src="../js/coverreport.js">

		</script><script type="text/javascript">
			RANGES_100 = [
   [38,17,38,18,'dccv']
, [39,17,39,51,'dccv']
, [40,13,40,14,'dccv']
, [47,17,47,18,'dccv']
, [48,17,48,66,'dccv']
, [48,84,48,99,'dccv']
, [49,13,49,14,'dccv']
, [66,17,66,18,'dccv']
, [67,17,67,48,'dccv']
, [67,62,67,86,'dccv']
, [68,13,68,14,'dccv']
, [75,17,75,18,'dccv']
, [76,17,76,55,'dccv']
, [77,13,77,14,'dccv']
, [84,17,84,18,'dccv']
, [85,17,85,68,'dccv']
, [86,13,86,14,'dccv']
, [157,13,157,91,'dccv']
, [157,13,157,91,'dccv']
, [156,9,156,56,'dccv']
, [156,57,156,58,'dccv']
, [158,13,158,30,'dccv']
, [159,13,159,34,'dccv']
, [160,13,160,34,'dccv']
, [161,13,161,41,'dccv']
, [162,13,162,43,'dccv']
, [163,13,163,71,'dccv']
, [164,13,164,61,'dccv']
, [165,13,165,34,'dccv']
, [166,13,166,33,'dccv']
, [167,13,167,28,'dccv']
, [168,9,168,10,'dccv']
, [174,13,174,106,'dccv']
, [174,13,174,106,'dccv']
, [173,29,173,30,'dccv']
, [176,13,176,33,'dccv']
, [177,13,177,71,'dccv']
, [178,13,178,20,'dccv']
, [178,35,178,47,'dccv']
, [178,21,178,31,'dccv']
, [178,49,178,50,'dccv']
, [179,17,179,41,'dccv']
, [180,17,180,61,'dccv']
, [181,17,181,44,'dccv']
, [182,13,182,14,'dccv']
, [178,32,178,34,'dccv']
, [184,13,184,55,'dccv']
, [185,13,185,33,'dccv']
, [186,13,186,31,'dccv']
, [187,13,187,37,'dccv']
, [188,9,188,10,'dccv']
, [175,13,175,44,'dccv']
, [194,13,194,70,'dccv']
, [194,13,194,70,'dccv']
, [193,29,193,30,'dccv']
, [196,13,196,34,'dccv']
, [197,13,197,35,'dccv']
, [197,36,197,53,'dccv']
, [198,9,198,10,'dccv']
, [195,13,195,45,'dccv']
, [204,13,204,41,'dccv']
, [203,31,203,32,'dccv']
, [205,13,205,38,'dccv']
, [205,39,205,59,'dccv']
, [206,9,206,10,'dccv']
, [214,13,214,125,'dccv']
, [214,13,214,125,'dccv']
, [213,55,213,56,'dccv']
, [215,13,215,38,'dccv']
, [216,9,216,10,'dccv']
, [224,13,224,51,'dccv']
, [223,59,223,60,'dccv']
, [225,13,225,61,'dccv']
, [226,9,226,10,'dccv']
, [244,13,244,87,'dccv']
, [244,13,244,87,'dccv']
, [243,56,243,57,'dccv']
, [245,13,245,48,'dccv']
, [246,13,246,25,'dccv']
, [246,26,246,27,'dccv']
, [247,17,247,33,'dccv']
, [248,13,248,14,'dccv']
, [248,20,248,21,'dccv']
, [249,16,249,34,'dccv']
, [250,13,250,14,'dccv']
, [251,9,251,10,'dccv']
, [256,35,256,36,'dccv']
, [257,13,257,70,'dccv']
, [258,9,258,10,'dccv']
, [263,33,263,34,'dccv']
, [264,13,264,44,'dccv']
, [265,13,265,50,'dccv']
, [266,13,266,54,'dccv']
, [267,13,267,36,'dccv']
, [268,13,268,38,'dccv']
, [270,13,270,33,'dccv']
, [270,34,270,48,'dccv']
, [272,13,272,26,'dccv']
, [273,13,273,25,'dccv']
, [273,26,273,27,'dccv']
, [274,17,274,31,'dccv']
, [275,13,275,14,'dccv']
, [276,9,276,10,'dccv']
, [284,13,284,117,'dccv']
, [284,13,284,117,'dccv']
, [283,47,283,48,'dccv']
, [285,13,285,42,'dccv']
, [286,13,286,53,'dccv']
, [287,13,287,71,'dccv']
, [288,9,288,10,'dccv']
, [304,13,304,44,'dccv']
, [303,55,303,56,'dccv']
, [305,13,305,64,'dccv']
, [306,9,306,10,'dccv']
, [48,66,48,84,'dccv']
, [67,48,67,62,'dccv']
, [187,38,187,57,'dcuc']
, [234,13,234,81,'dcuc']
, [234,13,234,81,'dcuc']
, [233,43,233,44,'dcuc']
, [235,13,235,44,'dcuc']
, [236,9,236,10,'dcuc']
, [294,55,294,56,'dcuc']
, [295,13,295,56,'dcuc']
, [295,57,295,77,'dcuc']
, [296,9,296,10,'dcuc']
, [295,56,295,57,'dcuc']
];
		</script><link rel="stylesheet" type="text/css" href="../css/coverreport.css" />
	</head><body>
		<code id="src100" class="dotCoverSource"><pre>// &lt;copyright file=&quot;Round.cs&quot;&gt;
//      ahal@itu.dk
// &lt;/copyright&gt;
// &lt;summary&gt;
//      A representation of a round in the Pirate Spades Game.
// &lt;/summary&gt;
// &lt;author&gt;Andreas Hallberg Kjeldsen (ahal@itu.dk)&lt;/author&gt;

namespace PirateSpades.GameLogic {
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Diagnostics.Contracts;

    /// &lt;summary&gt;
    /// A representation of a round in the Pirate Spades Game.
    /// &lt;/summary&gt;
    public class Round {
        /// &lt;summary&gt;
        /// The game currently being played
        /// &lt;/summary&gt;
        public Game Game { get; private set; }

        /// &lt;summary&gt;
        /// The round number
        /// &lt;/summary&gt;
        public int Number { get; private set; }

        /// &lt;summary&gt;
        /// The number of cards this round
        /// &lt;/summary&gt;
        public int Cards { get; private set; }

        /// &lt;summary&gt;
        /// The total number of cards in play this round
        /// &lt;/summary&gt;
        public int TotalCards {
            get {
                return Game.Players.Count * Cards;
            }
        }

        /// &lt;summary&gt;
        /// How many cards have been deal this round?
        /// &lt;/summary&gt;
        public int CardsDealt {
            get {
                return AwaitingBets ? Game.Players.Sum(player =&gt; player.CardsOnHand) : TotalCards;
            }
        }

        /// &lt;summary&gt;
        /// Is the round started?
        /// &lt;/summary&gt;
        public bool Started { get; private set; }

        /// &lt;summary&gt;
        /// Are we still awaiting bets from players?
        /// &lt;/summary&gt;
        public bool AwaitingBets { get; private set; }

        /// &lt;summary&gt;
        /// Have all players bet this round?
        /// &lt;/summary&gt;
        public bool BetsDone {
            get {
                return PlayerBets.Count(bet =&gt; bet.Value &gt; -1) == Game.Players.Count;
            }
        }

        /// &lt;summary&gt;
        /// Is the round finished?
        /// &lt;/summary&gt;
        public bool Finished {
            get {
                return Started &amp;&amp; TricksDone &gt;= Cards;
            }
        }

        /// &lt;summary&gt;
        /// Has all players played a card?
        /// &lt;/summary&gt;
        private bool PileDone {
            get {
                return BoardCards.Pile.Count == Game.Players.Count;
            }
        }

        /// &lt;summary&gt;
        /// Who is the dealer?
        /// &lt;/summary&gt;
        public int Dealer { get; private set; }

        /// &lt;summary&gt;
        /// Whose turn is it to play a card?
        /// &lt;/summary&gt;
        public int CurrentPlayer { get; private set; }

        /// &lt;summary&gt;
        /// What cards are on the table?
        /// &lt;/summary&gt;
        public Trick BoardCards { get; private set; }

        /// &lt;summary&gt;
        /// What was the last trick?
        /// &lt;/summary&gt;
        public Trick LastTrick { get; private set; }

        /// &lt;summary&gt;
        /// How many tricks have been played this round?
        /// &lt;/summary&gt;
        private int TricksDone { get; set; }

        /// &lt;summary&gt;
        /// May I have a dictionary describing the players&#39; won tricks?
        /// &lt;/summary&gt;
        public Dictionary&lt;Player, List&lt;Trick&gt;&gt; PlayerTricks { get; private set; }

        /// &lt;summary&gt;
        /// May I have a dictionary describing what the players have bet this round?
        /// &lt;/summary&gt;
        public Dictionary&lt;Player, int&gt; PlayerBets { get; private set; }

        /// &lt;summary&gt;
        /// Delegate to be used for events involving Round
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;round&quot;&gt;Round&lt;/param&gt;
        public delegate void RoundEventDelegate(Round round);

        /// &lt;summary&gt;
        /// Fires when a pile done
        /// &lt;/summary&gt;
        public event RoundEventDelegate NewPile;

        /// &lt;summary&gt;
        /// Fires when a round is started
        /// &lt;/summary&gt;
        public event RoundEventDelegate RoundStarted;

        /// &lt;summary&gt;
        /// Fires when a round hass begun
        /// &lt;/summary&gt;
        public event RoundEventDelegate RoundBegun;

        /// &lt;summary&gt;
        /// Fires when a round is finished
        /// &lt;/summary&gt;
        public event RoundEventDelegate RoundFinished;

        /// &lt;summary&gt;
        /// Make a new round with this game, number and dealer
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;game&quot;&gt;The game&lt;/param&gt;
        /// &lt;param name=&quot;number&quot;&gt;The roundnumber&lt;/param&gt;
        /// &lt;param name=&quot;dealer&quot;&gt;The dealer&lt;/param&gt;
        public Round(Game game, int number, int dealer) {
            Contract.Requires(game != null &amp;&amp; dealer &gt;= 0 &amp;&amp; dealer &lt; game.Players.Count);
            this.Game = game;
            this.Dealer = dealer;
            this.Number = number;
            this.CurrentPlayer = dealer;
            this.BoardCards = new Trick();
            this.PlayerTricks = new Dictionary&lt;Player, List&lt;Trick&gt;&gt;();
            this.PlayerBets = new Dictionary&lt;Player, int&gt;();
            this.Started = false;
            this.TricksDone = 0;
            this.Cards = 0;
        }

        /// &lt;summary&gt;
        /// Start this round
        /// &lt;/summary&gt;
        public void Start() {
            Contract.Requires(!Finished &amp;&amp; !AwaitingBets &amp;&amp; Game.Players.Count &gt;= Game.MinPlayersInGame);
            Contract.Ensures(AwaitingBets);
            this.Started = true;
            this.Cards = Card.CardsToDeal(Number, Game.Players.Count);
            foreach(var player in Game.Players) {
                player.IsDealer = false;
                PlayerTricks.Add(player, new List&lt;Trick&gt;());
                PlayerBets.Add(player, -1);
            }

            Game.Players[this.Dealer].IsDealer = true;
            AwaitingBets = true;
            this.NextPlayer();
            if(RoundStarted != null) RoundStarted(this);
        }

        /// &lt;summary&gt;
        /// Begin this round
        /// &lt;/summary&gt;
        public void Begin() {
            Contract.Requires(!Finished &amp;&amp; BetsDone &amp;&amp; AwaitingBets);
            Contract.Ensures(!AwaitingBets);
            AwaitingBets = false;
            if(RoundBegun != null) RoundBegun(this);
        }

        /// &lt;summary&gt;
        /// Finish this round
        /// &lt;/summary&gt;
        private void Finish() {
            Contract.Requires(Finished);
            if(RoundFinished != null) RoundFinished(this);
        }

        /// &lt;summary&gt;
        /// This player has bet this
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;player&quot;&gt;The player&lt;/param&gt;
        /// &lt;param name=&quot;bet&quot;&gt;The bet&lt;/param&gt;
        public void PlayerBet(Player player, int bet) {
            Contract.Requires(player != null &amp;&amp; bet &gt;= 0 &amp;&amp; bet &lt;= Cards &amp;&amp; AwaitingBets &amp;&amp; PlayerBets.ContainsKey(player));
            PlayerBets[player] = bet;
        }

        /// &lt;summary&gt;
        /// This player has bet this
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;playerName&quot;&gt;The player&lt;/param&gt;
        /// &lt;param name=&quot;bet&quot;&gt;The bet&lt;/param&gt;
        public void PlayerBet(string playerName, int bet) {
            Contract.Requires(playerName != null);
            this.PlayerBet(Game.GetPlayer(playerName), bet);
        }

        /// &lt;summary&gt;
        /// Has this player bet?
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;player&quot;&gt;The player&lt;/param&gt;
        /// &lt;returns&gt;The bet of the player&lt;/returns&gt;
        public bool HasPet(Player player) {
            Contract.Requires(player != null &amp;&amp; PlayerBets.ContainsKey(player));
            return PlayerBets[player] &gt; -1;
        }

        /// &lt;summary&gt;
        /// This player has played this card
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;player&quot;&gt;The player&lt;/param&gt;
        /// &lt;param name=&quot;card&quot;&gt;The card&lt;/param&gt;
        public void PlayCard(Player player, Card card) {
            Contract.Requires(player != null &amp;&amp; card != null &amp;&amp; player.HasCard(card));
            BoardCards.PlaceCard(player, card);
            if(PileDone) {
                this.NextPile();
            } else {
               this.NextPlayer(); 
            }
        }

        /// &lt;summary&gt;
        /// Switch the player turn
        /// &lt;/summary&gt;
        private void NextPlayer() {
            CurrentPlayer = (CurrentPlayer + 1) % Game.Players.Count;
        }

        /// &lt;summary&gt;
        /// Make a new pile and remove the old one
        /// &lt;/summary&gt;
        private void NextPile() {
            var winner = BoardCards.Winner;
            PlayerTricks[winner].Add(BoardCards);
            CurrentPlayer = Game.PlayerIndex(winner);
            LastTrick = BoardCards;
            BoardCards = new Trick();

            if (NewPile != null) NewPile(this);

            TricksDone++;
            if(Finished) {
                this.Finish();
            }
        }

        /// &lt;summary&gt;
        /// How much points did this player get this round?
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;player&quot;&gt;The player&lt;/param&gt;
        /// &lt;returns&gt;The points to be given to the player&lt;/returns&gt;
        public int PlayerScore(Player player) {
            Contract.Requires(player != null &amp;&amp; PlayerBets.ContainsKey(player) &amp;&amp; PlayerTricks.ContainsKey(player));
            var bet = PlayerBets[player];
            var tricks = PlayerTricks[player].Count;
            return bet == tricks ? 10 + bet : -Math.Abs(bet - tricks);
        }

        /// &lt;summary&gt;
        /// May I have a dictionary containing with all the players and how many points they got this round?
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public Dictionary&lt;Player, int&gt; PlayerScores() {
            return this.Game.Players.ToDictionary(p =&gt; p, this.PlayerScore);
        }

        /// &lt;summary&gt;
        /// How many rounds are possible?
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;players&quot;&gt;The amount of players&lt;/param&gt;
        /// &lt;returns&gt;The amount of rounds possible with this amount of players&lt;/returns&gt;
        public static int RoundsPossible(int players) {
            Contract.Requires(players &gt; 0);
            return (52 / players &lt; 10 ? 52 / players : 10) * 2;
        }
    }
}
</pre></code><script type="text/javascript">
			applyranges('src100', RANGES_100)
		</script>
	</body>
</html>